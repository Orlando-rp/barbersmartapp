#!/bin/bash

# =====================================================
# BarberSmart - Commit Message Validation Hook
# =====================================================
# Valida se a mensagem de commit segue o padrÃ£o Conventional Commits
# https://www.conventionalcommits.org/
# =====================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Get the commit message
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Skip if message starts with "fixup!" or "squash!"
if [[ "$COMMIT_MSG" =~ ^(fixup!|squash!) ]]; then
    exit 0
fi

# Conventional Commits pattern
# type(scope)?: subject
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9_-]+\))?(!)?: .{1,100}$"

# First line of commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

if [[ ! "$FIRST_LINE" =~ $PATTERN ]]; then
    echo ""
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}âŒ COMMIT REJEITADO: Mensagem nÃ£o segue o padrÃ£o${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Sua mensagem:${NC}"
    echo -e "  ${CYAN}$FIRST_LINE${NC}"
    echo ""
    echo -e "${GREEN}Formato esperado:${NC}"
    echo -e "  ${CYAN}<tipo>(<escopo>): <descriÃ§Ã£o>${NC}"
    echo ""
    echo -e "${BLUE}Tipos vÃ¡lidos:${NC}"
    echo -e "  ${GREEN}feat${NC}     - Nova funcionalidade"
    echo -e "  ${GREEN}fix${NC}      - CorreÃ§Ã£o de bug"
    echo -e "  ${GREEN}docs${NC}     - Apenas documentaÃ§Ã£o"
    echo -e "  ${GREEN}style${NC}    - FormataÃ§Ã£o (nÃ£o afeta cÃ³digo)"
    echo -e "  ${GREEN}refactor${NC} - RefatoraÃ§Ã£o de cÃ³digo"
    echo -e "  ${GREEN}perf${NC}     - Melhoria de performance"
    echo -e "  ${GREEN}test${NC}     - AdiÃ§Ã£o/correÃ§Ã£o de testes"
    echo -e "  ${GREEN}build${NC}    - Build system ou dependÃªncias"
    echo -e "  ${GREEN}ci${NC}       - ConfiguraÃ§Ã£o de CI"
    echo -e "  ${GREEN}chore${NC}    - Outras mudanÃ§as"
    echo -e "  ${GREEN}revert${NC}   - Reverter commit anterior"
    echo ""
    echo -e "${BLUE}Exemplos vÃ¡lidos:${NC}"
    echo -e "  ${CYAN}feat: adicionar login com Google${NC}"
    echo -e "  ${CYAN}fix(auth): corrigir token expirado${NC}"
    echo -e "  ${CYAN}docs: atualizar README${NC}"
    echo -e "  ${CYAN}feat!: alterar API de autenticaÃ§Ã£o${NC} (breaking change)"
    echo ""
    echo -e "${YELLOW}Dica: Use '!' antes de ':' para indicar breaking changes${NC}"
    echo ""
    exit 1
fi

# Check subject length (should be <= 72 characters for first line)
SUBJECT_LENGTH=${#FIRST_LINE}
if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo ""
    echo -e "${YELLOW}âš ï¸  AVISO: Primeira linha muito longa ($SUBJECT_LENGTH caracteres)${NC}"
    echo -e "  Recomendado: mÃ¡ximo 72 caracteres"
    echo ""
fi

# Check if subject starts with lowercase (convention)
SUBJECT=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+(\([^)]*\))?(!)?: //')
FIRST_CHAR=$(echo "$SUBJECT" | cut -c1)

if [[ "$FIRST_CHAR" =~ [A-Z] ]]; then
    echo -e "${YELLOW}ğŸ’¡ Dica: A descriÃ§Ã£o deve comeÃ§ar com letra minÃºscula${NC}"
    # Not blocking, just a suggestion
fi

echo -e "${GREEN}âœ… Commit vÃ¡lido!${NC}"
exit 0
