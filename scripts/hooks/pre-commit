#!/bin/bash

# =====================================================
# BarberSmart - Pre-commit Hook
# =====================================================
# Executa verifica√ß√µes antes de permitir o commit
# =====================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Executando verifica√ß√µes pr√©-commit...${NC}"

# Check for console.log statements in staged files (optional warning)
CONSOLE_LOGS=$(git diff --cached --name-only --diff-filter=ACM | xargs grep -l "console.log" 2>/dev/null || true)

if [ -n "$CONSOLE_LOGS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  AVISO: Encontrados console.log nos seguintes arquivos:${NC}"
    echo "$CONSOLE_LOGS" | while read file; do
        echo -e "   ${CYAN}$file${NC}"
    done
    echo -e "${YELLOW}   Considere remover antes do deploy.${NC}"
    echo ""
fi

# Check for debugger statements
DEBUGGERS=$(git diff --cached --name-only --diff-filter=ACM | xargs grep -l "debugger" 2>/dev/null || true)

if [ -n "$DEBUGGERS" ]; then
    echo -e "${RED}‚ùå ERRO: Encontrados 'debugger' statements:${NC}"
    echo "$DEBUGGERS" | while read file; do
        echo -e "   ${CYAN}$file${NC}"
    done
    echo -e "${RED}   Remova antes de commitar.${NC}"
    exit 1
fi

# Check for TODO/FIXME with high priority markers
TODOS=$(git diff --cached --name-only --diff-filter=ACM | xargs grep -l "TODO.*URGENT\|FIXME.*URGENT\|XXX" 2>/dev/null || true)

if [ -n "$TODOS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  AVISO: Encontrados TODOs urgentes:${NC}"
    echo "$TODOS" | while read file; do
        echo -e "   ${CYAN}$file${NC}"
    done
    echo ""
fi

# Check for large files (> 1MB)
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$file ($((SIZE / 1024))KB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  AVISO: Arquivos grandes detectados:${NC}"
    echo "$LARGE_FILES" | while read file; do
        echo -e "   ${CYAN}$file${NC}"
    done
    echo -e "${YELLOW}   Considere otimizar ou usar Git LFS.${NC}"
    echo ""
fi

# Check for secrets/API keys patterns (basic check)
SECRETS_PATTERN="(api[_-]?key|apikey|secret[_-]?key|password|passwd|token)[[:space:]]*[:=][[:space:]]*['\"][^'\"]{8,}['\"]"
SECRETS=$(git diff --cached --diff-filter=ACM -U0 | grep -iE "$SECRETS_PATTERN" || true)

if [ -n "$SECRETS" ]; then
    echo -e "${RED}‚ùå ERRO: Poss√≠veis secrets/API keys detectados!${NC}"
    echo -e "${RED}   Verifique se n√£o est√° commitando credenciais.${NC}"
    echo ""
    echo -e "${YELLOW}Se for um falso positivo, use:${NC}"
    echo -e "   ${CYAN}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}‚úÖ Verifica√ß√µes conclu√≠das!${NC}"
exit 0
